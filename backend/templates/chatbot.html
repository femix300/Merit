<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Interface</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+1:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Navbar styling */
            .navbar {
                background-color: #6b2dcc; /* Adjusted to match the image color */
                color: white;
                box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
                padding: 20px 0; /* Increased padding for better spacing */
            }
    
            .navbar-container {
                max-width: 1200px;
                margin: 0 auto;
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0 20px;
            }
    
            .logo a {
                font-size: 28px; /* Slightly larger font for logo */
                font-weight: bold;
                color: white;
                text-decoration: none;
            }
    
            .nav-links {
                display: flex;
                gap: 25px; /* Spaced out the nav items more */
                align-items: center;
            }
    
            .nav-links a {
                color: white;
                text-decoration: none;
                font-size: 18px; /* Increased the font size */
                padding: 5px 10px;
            }
    
            .nav-links a:hover {
                color: lightgray;
            }
    
            .dropdown {
                position: relative;
                display: inline-block;
            }
    
            .dropdown-btn {
                background: none;
                border: none;
                color: white;
                font-size: 18px;
                cursor: pointer;
            }
    
            .dropdown-content {
                display: none;
                position: absolute;
                background-color: white;
                min-width: 160px;
                box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.2);
                z-index: 1;
                border-radius: 4px;
            }
    
            .dropdown-content a {
                color: black;
                padding: 12px 16px;
                text-decoration: none;
                display: block;
            }
    
            .dropdown-content a:hover {
                background-color: #ddd;
            }
    
            .dropdown:hover .dropdown-content {
                display: block;
            }
    
            /* Mobile Menu Button */
            .mobile-menu-btn {
                display: none;
                background: none;
                border: none;
                color: white;
                font-size: 24px;
                cursor: pointer;
            }
    
            /* Mobile Dropdown */
            #mobileDropdown {
                display: none;
                flex-direction: column;
                background-color: #6b2dcc; /* Adjusted to match the navbar background */
                position: absolute;
                width: 100%;
                top: 60px;
                left: 0;
            }
    
            #mobileDropdown a, .mobile-dropdown-btn {
                color: white;
                padding: 10px 20px;
                text-decoration: none;
            }
    
            .mobile-dropdown-content {
                display: none;
                flex-direction: column;
                background-color: #6b2dcc; /* Adjusted to match the navbar background */
            }
    
            .mobile-dropdown-btn {
                background: none;
                border: none;
                color: white;
                font-size: 16px;
                cursor: pointer;
            }
    
            .mobile-dropdown-btn:hover {
                background-color: #4c38be;
            }
    
            .mobile-dropdown-content a:hover {
                background-color: #ddd;
                color: black;
            }
    
            /* Show the mobile dropdown menu when active */
            .show {
                display: flex !important;
            }
    
            /* Responsive Styles */
            @media (max-width: 768px) {
                .nav-links {
                    display: none;
                }
    
                .mobile-menu-btn {
                    display: block;
                }
    
                .dropdown-content, .mobile-dropdown-content {
                    display: none;
                }
            }
    
           /* General styles */
            body {
                font-family: 'M PLUS 1', sans-serif;
                background-color: white; /* Set the body background to white */
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                height: 100vh;
                margin: 0;
                color: black; /* Set default text color to black */
            }
    
            /* Chat container */
            .chat-container {
                width: 900px;
                height: 80vh;
                background-color: #5c48ee; /* Background color of the chat container */
                border-radius: 10px;
                box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
                padding: 20px;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                color: black; /* Set text color inside chat container to black */
            }
    
            /* Message area styling */
            .message-area {
                flex-grow: 1;
                overflow-y: auto;
                margin-bottom: 20px;
                padding: 10px;
                border-radius: 10px;
                background-color: #f9f9f9; /* Light background for the message area */
            }
    
            /* Message bubble */
            .message {
                margin: 10px 0;
                padding: 10px;
                border-radius: 20px;
                font-size: 14px;
                max-width: 75%;
                word-wrap: break-word;
                box-shadow: 0px 2px 6px rgba(0, 0, 0, 0.1);
            }
    
            /* User message styling */
            .message.user {
                background-color: white; /* User messages will have a white background */
                color: black; /* Text color for user messages */
                margin-left: auto;
                text-align: right;
                border-radius: 20px 20px 0 20px; /* Round top-right and bottom-right corners */
            }
    
            /* Bot message styling */
            .message.bot {
                background-color: white; /* Bot messages will also have a white background */
                color: black; /* Text color for bot messages */
                border-radius: 20px 20px 20px 0; /* Round top-left and bottom-left corners */
            }
    
            /* The Input area */
            .input-area {
                display: flex;
                align-items: flex-start; /* Align items to start */
                gap: 10px;
            }
    
            textarea {
                flex-grow: 1; /* Makes it flexible in the input area */
                padding: 10px; /* Same padding as input */
                border: none; /* No border */
                border-radius: 20px; /* Same border radius as input */
                font-size: 16px; /* Same font size */
                color: black; /* Text color */
                background-color: #f1f1f1; /* Light background for input */
                resize: none; /* Prevent manual resizing */
                overflow: hidden; /* Hide overflow */
                max-height: 120px; /* Set a maximum height */
                line-height: 1.5; /* Control the line height for better spacing */
                transition: height 0.2s ease; /* Smooth transition for height change */
                height: auto;
                min-height: 16px;
            }
    
            button {
                padding: 10px 20px;
                background-color:  black; /* Dark Slate Gray button color */
                color: white; /* Button text color */
                border: none;
                border-radius: 20px;
                cursor: pointer;
                font-size: 16px;
            }
            
            button:hover {
                background-color: #1C3131; /* Darker version of Dark Slate Gray on hover */
            }
    
            strong {
                font-weight: bold;
            }
    
            em {
                font-style: italic;
            }

    </style>
</head>
<body>
    <header class="navbar">
        <div class="navbar-container">
            <!-- Logo -->
            <div class="logo">
                <a href="/">Merit.com</a>
            </div>
            
            <!-- Navigation Links -->
            <nav class="nav-links">
                <a href="/">Home</a>
                <a href="http://127.0.0.1:5000/merit.ai">Merit AI</a>
                
                <!-- Dropdown Menu -->
                <div class="dropdown">
                    <button class="dropdown-btn">Service ▼</button>
                    <div class="dropdown-content">
                        <a href="/service/aggregate-calculator">Aggregate calculator</a>
                        <a href="/universities-list">Find dream school</a>
                    </div>
                </div>
                
                <a href="/about">About</a>
            </nav>
            
            <!-- Mobile Menu Button -->
            <button class="mobile-menu-btn">☰</button>
        </div>
        
        <!-- Mobile Dropdown for Mobile View -->
        <div class="mobile-dropdown" id="mobileDropdown">
            <a href="/">Home</a>
            <a href="http://127.0.0.1:5000/merit.ai">Merit AI</a>
            <button class="mobile-dropdown-btn">Service ▼</button>
            <div class="mobile-dropdown-content">
                <a href="/service/aggregate-calculator">Aggregate calculator</a>
                <a href="/universities-list">Find dream school</a>
            </div>
            <a href="/about">About</a>
        </div>
    </header>
    <div class="chat-container">
        <div class="message-area" id="chat-box"></div>
        <div class="input-area">
            <textarea id="user-input" rows="1" placeholder="Type your message here..." style="resize: none;"></textarea>
            <button id="send-button">Send</button>
        </div>
    </div>

    <script>
        // Toggle mobile dropdown visibility
        const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
        const mobileDropdown = document.getElementById('mobileDropdown');
        const mobileDropdownBtn = document.querySelector('.mobile-dropdown-btn');
        const mobileDropdownContent = document.querySelector('.mobile-dropdown-content');
    
        mobileMenuBtn.addEventListener('click', function() {
            mobileDropdown.classList.toggle('show');
        });
    
        // Toggle service dropdown on mobile
        mobileDropdownBtn.addEventListener('click', function() {
            mobileDropdownContent.classList.toggle('show');
        });
    

        const chatBox = document.getElementById("chat-box");
        const userInput = document.getElementById("user-input");
        const sendButton = document.getElementById("send-button");

        function formatMessage(message) {
            // Format bold and italic text using asterisks
            message = message.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>'); // Bold Italics
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
            message = message.replace(/\*(.*?)\*/g, '$1'); // Italics
            
            // Replace new lines (\n) with <br> for proper line breaks
            message = message.replace(/\n/g, '<br>');
        
            // Replace bullet points (- or *) with list items (<li> tags)
            message = message.replace(/^[-*] (.*?)(\n|$)/gm, '<li>$1</li>');
        
            // Wrap the list items in <ul> tags to create a proper list
            message = message.replace(/(<li>.*?<\/li>)/g, '<ul>$1</ul>');
        
            return message;
        }
               

        let isUserAtBottom = true; // Tracks whether the user is at the bottom of the chat

        // Check if the user is at the bottom of the chat box
        function checkScrollPosition() {
            const chatHeight = chatBox.scrollHeight;
            const visibleHeight = chatBox.clientHeight;
            const scrollPosition = chatBox.scrollTop;

            // If the user is within 20px from the bottom, consider them at the bottom
            isUserAtBottom = chatHeight - (visibleHeight + scrollPosition) < 20;
        }

        // Auto-scroll only if the user is at the bottom
        function autoScroll() {
            if (isUserAtBottom) {
                chatBox.scrollTop = chatBox.scrollHeight; // Scroll to the bottom
            }
        }

        // Listen for scroll events to detect when the user scrolls up or down
        chatBox.addEventListener('scroll', checkScrollPosition);

        // Adjust height of textarea based on content
        function autoResizeTextarea() {
            this.style.height = 'auto'; // Reset height
            this.style.height = `${Math.min(this.scrollHeight, 120)}px`; // Set new height with max limit
        }

        // Modified typeMessage function to respect user's scroll
        function typeMessage(messageDiv, message) {
            const formattedMessage = formatMessage(message); // Format the message
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = formattedMessage;

            const elements = Array.from(tempDiv.childNodes); // Get all child nodes (text and elements)

            let currentElementIndex = 0;
            let typingIndex = 0;

            const typingSpeed = 10; // Typing speed

            function typeCharacter() {
                if (currentElementIndex < elements.length) {
                    const currentNode = elements[currentElementIndex];

                    if (currentNode.nodeType === Node.TEXT_NODE) {
                        // If it's a text node, type character by character
                        if (typingIndex < currentNode.textContent.length) {
                            messageDiv.innerHTML += currentNode.textContent.charAt(typingIndex);
                            typingIndex++;
                            setTimeout(typeCharacter, typingSpeed);
                            autoScroll(); // Only auto-scroll if the user is at the bottom
                        } else {
                            // Move to the next node when done with this one
                            currentElementIndex++;
                            typingIndex = 0;
                            typeCharacter(); // Continue typing the next node
                        }
                    } else if (currentNode.nodeType === Node.ELEMENT_NODE) {
                        // If it's an HTML element, add it directly and move on
                        messageDiv.appendChild(currentNode.cloneNode(true)); // Append the HTML element
                        currentElementIndex++;
                        typeCharacter(); // Continue typing the next node
                        autoScroll(); // Only auto-scroll if the user is at the bottom
                    }
                }
            }

            typeCharacter(); // Start typing
        }

        function appendMessage(sender, message) {
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("message", sender);
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight; // Scroll to the bottom

            if (sender === 'bot') {
                typeMessage(messageDiv, formatMessage(message)); // Use typing effect for bot
            } else {
                messageDiv.innerHTML = formatMessage(message); // Display user message directly
            }
        }

        async function sendMessage() {
            const message = userInput.value.trim(); // Trim whitespace from input
            if (!message) return; // Ignore empty messages
        
            appendMessage("user", message); // Append user message to chat
            userInput.value = ""; // Clear input box immediately
            autoResizeTextarea.call(userInput); // Reset the height of textarea
        
            const response = await fetch("/chat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ message }),
            });
        
            const data = await response.json();
            appendMessage("bot", data.response); // Append bot message with typing effect
        }
        

        sendButton.addEventListener("click", sendMessage);

        userInput.addEventListener("input", autoResizeTextarea); // Adjust height on input
        userInput.addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
                if (!event.shiftKey) {
                    event.preventDefault(); // Prevent default behavior of adding new line
                    sendMessage(); // Send the message when Enter is pressed
                }
                // If Shift + Enter is pressed, allow new line
            }
        });
    </script>
</body>
</html>
